# 
## ✅ 项目名称：卡密授权服务系统（基于 Python + MySQL）

---

## 一、项目目标

构建一个简洁、可部署、支持前缀和有效期控制的卡密授权服务，具备：

* **卡密校验 API（绑定机器码 + 有效期 + 状态变更）**
* **Web 管理后台：卡密增删改查 + 批量生成 + 导出未使用卡密**
* **MySQL 数据挂载卷 + 自动建表 SQL**
* **容器化部署（Docker Compose）**

---

## 二、数据库结构（MySQL）

### 数据库：`kamisystem`

### 表：`cards`

| 字段名           | 类型           | 说明                              |
| ------------- | ------------ | ------------------------------- |
| id            | INT          | 主键，自增                           |
| prefix        | VARCHAR(16)  | 卡密前缀                            |
| code          | VARCHAR(64)  | 随机生成主体                          |
| full\_code    | VARCHAR(128) | `prefix-code` 拼接字段              |
| used\_at      | DATETIME     | 第一次使用时间                         |
| expire\_at    | DATETIME     | 使用后 3 小时到期                      |
| machine\_code | VARCHAR(128) | 绑定设备码                           |
| status        | ENUM         | `unused` / `active` / `expired` |
| created\_at   | DATETIME     | 创建时间                            |

---

## 三、初始化脚本 `mysql/init.sql`

```sql
CREATE DATABASE IF NOT EXISTS kamisystem DEFAULT CHARSET utf8mb4;
USE kamisystem;

CREATE TABLE IF NOT EXISTS cards (
    id INT AUTO_INCREMENT PRIMARY KEY,
    prefix VARCHAR(16) NOT NULL,
    code VARCHAR(64) NOT NULL,
    full_code VARCHAR(128) NOT NULL UNIQUE,
    used_at DATETIME DEFAULT NULL,
    expire_at DATETIME DEFAULT NULL,
    machine_code VARCHAR(128) DEFAULT NULL,
    status ENUM('unused', 'active', 'expired') DEFAULT 'unused',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

---

## 四、功能模块

### 1. 卡密验证接口（API）

* `POST /api/validate`
* 参数：

```json
{
  "code": "VIP-ABCD123456",
  "machine_code": "PC-UUID-123"
}
```

* 逻辑：

  * 校验 full\_code 是否存在
  * 状态为 `unused`：绑定机器码、设定 3 小时过期时间、变为 `active`
  * 状态为 `active`：校验是否未过期且机器码一致
  * 状态为 `expired`：拒绝
* 返回示例：

```json
{ "status": "success", "message": "授权成功" }
```

---

### 2. Web 管理界面（Flask + Bootstrap）

#### 功能一：卡密管理列表

* 查询、筛选（按状态、前缀）
* 编辑、删除、单条修改

#### 功能二：**批量生成卡密（新增） ✅**

* 输入：

  * **前缀**（如：`VIP`）
  * **数量**（如：`100`）
  * 可选字段：code长度（默认 10）
* 点击“生成”后：

  * 后台随机生成 N 条记录
  * 格式为：`VIP-XXXXXXXXXX`
  * 状态均为 `unused`

#### 功能三：导出未使用卡密为 TXT

* 导出路径：服务器生成 `.txt`
* 内容示例：

```
VIP-ABCD123456
VIP-EFGH789012
```

---

## 五、部署方式（Docker Compose）

```yaml
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: rootpwd
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./mysql/init.sql:/docker-entrypoint-initdb.d/init.sql:ro

  web:
    build: ./web
    ports:
      - "5000:5000"
    depends_on:
      - mysql
    environment:
      - FLASK_ENV=development

volumes:
  mysql_data:
```

---

## 六、项目结构建议

```
project-root/
├── docker-compose.yml
├── mysql/
│   └── init.sql
├── web/
│   ├── app.py
│   ├── models.py
│   ├── routes/
│   │   ├── api.py
│   │   └── admin.py
│   ├── templates/
│   │   ├── index.html        # 管理列表页
│   │   ├── generate.html     # 批量生成页 ✅
│   ├── utils/
│   │   └── export_txt.py     # TXT 导出
└── requirements.txt
```

---

## 七、开发任务更新

| 模块               | 状态     | 说明                        |
| ---------------- | ------ | ------------------------- |
| 数据结构和初始化 SQL     | ✅      | prefix、code、full\_code 结构 |
| 卡密校验接口实现         | ⏳      | Flask API，处理绑定+倒计时逻辑      |
| Web 管理：增删改查 + 筛选 | ⏳      | 使用 Jinja2 + Bootstrap     |
| **批量生成卡密页面功能**   | ✅ 设计完成 | 已添加到需求中                   |
| 导出未使用卡密为 TXT     | ⏳      | 一行一个，支持下载                 |
| Docker 容器挂载和部署   | ✅      | MySQL 卷 + 初始化脚本自动执行       |

---
