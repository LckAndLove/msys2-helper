# 功能改进说明

## 更新内容

### 1. 修复HTTP超时错误处理
**问题**: 使用过期卡密时，程序会等待HTTP超时，然后显示"网络异常"错误

**解决方案**:
- 改进了`validate_license`函数的错误处理
- 添加了对HTTP错误代码的详细处理
- 现在会正确显示服务器返回的具体错误信息（如"卡密已过期"、"卡密不存在"等）
- 区分网络连接错误和服务器返回的业务错误

**改进点**:
```python
# 新增HTTP错误处理
except urllib.error.HTTPError as e:
    # 解析服务器返回的错误信息
    try:
        error_data = json.loads(e.read().decode('utf-8'))
        return False, error_data.get('message', f'服务器错误: {e.code}')
    except:
        return False, f'服务器错误: {e.code} - {e.reason}'
```

### 2. 新增VS Code重置功能
**功能**: 一键重置VS Code用户配置

**实现内容**:
- 删除 `%APPDATA%\Code` 文件夹（用户配置、缓存）
- 删除 `%USERPROFILE%\.vscode` 文件夹（已安装扩展）
- 自动备份配置到带时间戳的备份文件夹
- 提供确认对话框，防止误操作
- 需要管理员权限执行

**使用方法**:
1. 点击"[工具] 重置VS Code配置"按钮
2. 确认操作（会显示详细的操作说明）
3. 程序会自动备份现有配置
4. 删除VS Code配置文件
5. 完成后显示备份位置

### 3. 界面布局调整
**改进**:
- 窗口大小从 `500x400` 调整为 `520x480`
- 添加了功能分隔线
- 新增VS Code重置按钮
- 保持界面美观和功能性

## 使用前准备

### 1. 确保卡密系统运行
```bash
cd kamisystem
docker-compose up -d
```

### 2. 检查API配置
确保 `auth_config.py` 中的API地址正确：
```python
API_BASE_URL = "http://47.95.197.53:5000"
```

### 3. 运行测试脚本
```bash
python test_improvements.py
```

## 测试步骤

### 1. 测试错误处理改进
1. 使用无效卡密测试
2. 使用过期卡密测试
3. 观察错误信息是否正确显示

### 2. 测试VS Code重置功能
1. 确保VS Code已安装且有配置
2. 点击重置按钮
3. 确认操作
4. 检查备份是否创建
5. 检查配置是否被删除

### 3. 测试授权流程
1. 启动程序
2. 输入有效卡密
3. 验证功能是否正常解锁

## 注意事项

1. **管理员权限**: 程序需要管理员权限运行
2. **网络连接**: 需要能够访问卡密验证API
3. **备份安全**: VS Code重置会自动备份，但建议手动备份重要配置
4. **卡密有效期**: 确保使用有效的卡密进行测试

## 常见问题

### Q: 显示"网络连接失败"
A: 检查网络连接和API服务器状态

### Q: 显示"服务器错误"
A: 检查卡密系统是否正常运行

### Q: VS Code重置失败
A: 确保以管理员身份运行程序，并关闭VS Code

### Q: 备份文件夹在哪里
A: 备份保存在用户主目录下，格式为 `VSCode_Backup_YYYYMMDD_HHMMSS`
